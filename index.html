<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Супер Тест Web App</title>
    <style>
        body { font-family: sans-serif; padding: 15px; margin: 0; background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); }
        .container { display: flex; flex-direction: column; gap: 15px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid var(--tg-theme-hint-color, #ccc); border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        #log-container { margin-top: 15px; }
        #log { padding: 10px; border: 1px dashed var(--tg-theme-hint-color, #ddd); border-radius: 5px; font-size: 11px; max-height: 200px; overflow-y: auto; word-break: break-all; background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        #log p { margin: 2px 0; padding-bottom: 2px; border-bottom: 1px solid var(--tg-theme-hint-color, #eee); }
        #log p.error { color: red; font-weight: bold; }
        #log p.success { color: green; font-weight: bold; }
        #log p.info { color: blue; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <h1>Супер Тестовый Web App</h1>
        <p>Версия: 1.1</p>
        <div>
            <label for="dataField">Введите текст для отправки:</label>
            <input type="text" id="dataField" placeholder="Любой текст здесь">
        </div>

        <div id="log-container">
            <strong>Логи Web App (смотрите здесь!):</strong>
            <div id="log"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const logDiv = document.getElementById('log');
        let logCounter = 1;

        function webAppLog(message, type = 'info') {
            console.log(`[WebApp ${type.toUpperCase()}]`, message);
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `${logCounter++}. [${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        webAppLog("--- Web App скрипт запущен ---");

        if (typeof Telegram === 'undefined' || !Telegram.WebApp) {
            webAppLog("ОШИБКА КРИТИЧЕСКАЯ: Объект Telegram или Telegram.WebApp НЕ определен!", 'error');
            alert("Критическая ошибка: Telegram SDK не загружен. Пожалуйста, сообщите разработчику.");
        } else {
            webAppLog("Объект Telegram.WebApp определен.", 'success');
            webAppLog(`Версия SDK: ${tg.version}`);
            webAppLog(`Платформа: ${tg.platform}`);
            webAppLog(`Цветовая схема: ${tg.colorScheme}`);
            webAppLog(`initDataUnsafe: ${JSON.stringify(tg.initDataUnsafe)}`);

            tg.ready();
            webAppLog("tg.ready() вызван.", 'success');

            tg.expand();
            webAppLog("tg.expand() вызван.", 'success');

            tg.MainButton.setText("Отправить Текст");
            tg.MainButton.color = tg.themeParams.button_color || "#2481CC";
            tg.MainButton.textColor = tg.themeParams.button_text_color || "#FFFFFF";
            webAppLog("MainButton настроена.", 'success');

            const dataField = document.getElementById('dataField');

            dataField.addEventListener('input', function() {
                if (dataField.value.trim().length > 0) {
                    if (!tg.MainButton.isVisible) tg.MainButton.show();
                    if (!tg.MainButton.isActive) tg.MainButton.enable();
                } else {
                    if (tg.MainButton.isVisible) tg.MainButton.hide();
                }
            });

            tg.MainButton.hide(); // Скрыта по умолчанию
            webAppLog("MainButton по умолчанию скрыта.");

            tg.MainButton.onClick(function() {
                webAppLog("--- MainButton onClick СРАБОТАЛ ---", 'success');
                const textValue = dataField.value.trim();

                if (textValue.length === 0) {
                    webAppLog("Попытка отправить пустые данные. Показ showAlert.", 'error');
                    tg.showAlert("Пожалуйста, введите текст.");
                    return;
                }

                const dataPayload = {
                    text_message: textValue,
                    client_timestamp: new Date().toISOString(),
                    app_version: "1.1"
                };
                const jsonPayload = JSON.stringify(dataPayload);

                webAppLog(`Подготовлен JSON для отправки: ${jsonPayload}`, 'info');

                tg.MainButton.showProgress(false); // Показываем жирный индикатор
                tg.MainButton.disable();
                webAppLog("MainButton.showProgress(false) и disable() вызваны.", 'info');

                webAppLog("--- Сейчас будет вызван tg.sendData() ---", 'info');
                try {
                    tg.sendData(jsonPayload);
                    // ЕСЛИ ВЫ ВИДИТЕ ЭТО СООБЩЕНИЕ В ЛОГАХ ВНУТРИ TELEGRAM,
                    // А БОТ НЕ РЕАГИРУЕТ - ПРОБЛЕМА НЕ В ВЫЗОВЕ sendData, А В ЧЕМ-ТО ЕЩЕ
                    // (например, неправильные данные initData, которые Telegram не может проверить, или блокировка на стороне Telegram)
                    webAppLog("УСПЕХ: tg.sendData() был вызван БЕЗ ОШИБКИ JavaScript!", 'success');
                    webAppLog("Ожидайте реакции бота...", 'info');

                    tg.HapticFeedback.notificationOccurred('success');

                    // Не скрываем прогресс сразу, чтобы он был виден
                    // Скроется, если бот ответит или по таймауту (если нужен)
                    // Можно поменять текст кнопки
                    // tg.MainButton.setText("Отправлено, ждем...");

                } catch (e) {
                    webAppLog(`КРИТИЧЕСКАЯ ОШИБКА при вызове tg.sendData(): ${e.toString()}`, 'error');
                    tg.showAlert(`Ошибка JS при отправке: ${e.toString()}`);
                    tg.MainButton.hideProgress();
                    tg.MainButton.enable();
                }
                webAppLog("--- обработчик onClick завершен ---", 'info');
            });
        }
        webAppLog("--- Загрузка скрипта Web App полностью завершена ---", 'success');
    </script>
</body>
</html>