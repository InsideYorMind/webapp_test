<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>Простой Web App</title>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            padding: 15px;
            margin: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
            overscroll-behavior: none; /* Предотвращает "оттягивание" страницы на мобильных */
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            border-radius: 5px;
            font-size: 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        #log {
            margin-top: 20px;
            padding: 10px;
            border: 1px dashed var(--tg-theme-hint-color, #dddddd);
            border-radius: 5px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            word-break: break-all;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        #log p {
            margin: 2px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color, #eee);
            padding-bottom: 2px;
        }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <h1>Тестовый Web App</h1>

        <div>
            <label for="dataField">Введите текст:</label>
            <input type="text" id="dataField" placeholder="Любой текст">
        </div>

        <div id="log-container">
            <strong>Логи Web App (в браузере):</strong>
            <div id="log"></div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const logDiv = document.getElementById('log');

        function webAppLog(message) {
            console.log("[Web App Log]", message); // Лог в консоль разработчика
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight; // Автопрокрутка вниз
        }

        webAppLog("Web App инициализация...");

        if (!tg || !tg.initData) {
            webAppLog("ОШИБКА: Telegram WebApp SDK (tg) не загружен или initData отсутствует!");
            // Можно показать пользователю сообщение об ошибке
            alert("Не удалось инициализировать Telegram Web App. Попробуйте перезапустить.");
        } else {
            webAppLog("Telegram SDK (tg) загружен. Версия: " + tg.version);
            webAppLog("tg.initDataUnsafe: " + JSON.stringify(tg.initDataUnsafe));
            webAppLog("tg.colorScheme: " + tg.colorScheme);
            webAppLog("tg.themeParams: " + JSON.stringify(tg.themeParams));

            tg.ready();
            webAppLog("tg.ready() вызван.");

            tg.expand();
            webAppLog("tg.expand() вызван.");

            // Настройка MainButton
            tg.MainButton.setText("Отправить данные");
            webAppLog("MainButton текст установлен: 'Отправить данные'");
            tg.MainButton.color = tg.themeParams.button_color || "#007AFF";
            tg.MainButton.textColor = tg.themeParams.button_text_color || "#FFFFFF";

            const dataField = document.getElementById('dataField');

            // Показываем/скрываем MainButton в зависимости от наличия текста
            dataField.addEventListener('input', function() {
                if (dataField.value.trim().length > 0) {
                    if (!tg.MainButton.isVisible) {
                        tg.MainButton.show();
                        webAppLog("MainButton показана (текст введен).");
                    }
                    if (!tg.MainButton.isActive) {
                         tg.MainButton.enable();
                         webAppLog("MainButton активирована.");
                    }
                } else {
                    if (tg.MainButton.isVisible) {
                        tg.MainButton.hide();
                        webAppLog("MainButton скрыта (текст пуст).");
                    }
                }
            });

            // Изначально кнопка скрыта, пока не введен текст
            tg.MainButton.hide();
            webAppLog("MainButton изначально скрыта.");

            // Обработчик нажатия на MainButton
            tg.MainButton.onClick(function() {
                webAppLog("MainButton нажата.");
                const textToSend = dataField.value.trim();

                if (textToSend.length === 0) {
                    webAppLog("Попытка отправить пустые данные. Отмена.");
                    tg.showAlert("Пожалуйста, введите текст для отправки.");
                    return;
                }

                const dataToSend = {
                    message: textToSend,
                    timestamp: new Date().toISOString()
                };
                const jsonData = JSON.stringify(dataToSend);

                webAppLog("Подготовлены данные для отправки: " + jsonData);

                tg.MainButton.showProgress(false); // Показываем индикатор загрузки
                webAppLog("MainButton.showProgress(false) вызван.");
                tg.MainButton.disable(); // Делаем кнопку неактивной
                webAppLog("MainButton.disable() вызван.");

                try {
                    tg.sendData(jsonData);
                    webAppLog("tg.sendData() успешно вызван с данными: " + jsonData);

                    // Имитация "успешной отправки" на стороне клиента
                    // Не закрываем сразу, чтобы увидеть реакцию бота
                    tg.HapticFeedback.notificationOccurred('success');
                    webAppLog("Тактильный отклик 'success'.");

                    // Скрываем прогресс и меняем кнопку через небольшую задержку
                    setTimeout(() => {
                        tg.MainButton.hideProgress();
                        webAppLog("MainButton.hideProgress() вызван.");
                        tg.MainButton.setText("Данные отправлены!");
                        webAppLog("MainButton текст изменен: 'Данные отправлены!'");
                        // Оставим кнопку неактивной, чтобы показать что отправка была
                        // tg.MainButton.enable(); // Если нужно разрешить повторную отправку

                        // Очистить поле ввода после "успешной" отправки
                        // dataField.value = "";
                        // tg.MainButton.hide(); // Скрыть кнопку, т.к. поле пустое

                    }, 1500);

                } catch (e) {
                    webAppLog("ОШИБКА при вызове tg.sendData(): " + e.toString());
                    tg.showAlert("Произошла ошибка при отправке данных: " + e.toString());
                    tg.MainButton.hideProgress();
                    tg.MainButton.enable();
                    webAppLog("MainButton.hideProgress() и enable() вызваны после ошибки.");
                }
            });
        }
        webAppLog("Инициализация скрипта Web App завершена.");
    </script>
</body>
</html>